name: Deploy Laravel to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HOST_DNS }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 120s
          command_timeout: 20m
          script: |
            # Define paths
            APP_DIR=/var/www/flyertrade
            RELEASES_DIR=$APP_DIR/releases
            CURRENT_DIR=$APP_DIR/current
            TIMESTAMP=$(date +"%Y%m%d%H%M%S")
            NEW_RELEASE=$RELEASES_DIR/$TIMESTAMP

            echo "ðŸ‘‰ Creating new release folder..."
            mkdir -p $NEW_RELEASE

            echo "ðŸ‘‰ Copying code into release folder..."
            rsync -av --exclude='.git' ./ $NEW_RELEASE/

            echo "ðŸ‘‰ Installing composer dependencies..."
            php -d memory_limit=-1 $(which composer) install --no-dev --optimize-autoloader --no-interaction -d $NEW_RELEASE

            echo "ðŸ‘‰ Setting storage and bootstrap/cache permissions..."
            sudo chown -R www-data:www-data $NEW_RELEASE/storage $NEW_RELEASE/bootstrap/cache
            sudo chmod -R 775 $NEW_RELEASE/storage $NEW_RELEASE/bootstrap/cache

            echo "ðŸ‘‰ Linking current release..."
            ln -sfn $NEW_RELEASE $CURRENT_DIR

            echo "ðŸ‘‰ Running migrations..."
            php $CURRENT_DIR/artisan migrate --force

            echo "ðŸ‘‰ Clearing and caching config/routes/views..."
            php $CURRENT_DIR/artisan config:cache
            php $CURRENT_DIR/artisan route:cache
            php $CURRENT_DIR/artisan view:cache

            echo "ðŸ‘‰ Reloading services..."
            sudo systemctl reload php8.2-fpm || true
            sudo systemctl reload nginx || true

            echo "ðŸ‘‰ Cleaning old releases (keep last 5)..."
            cd $RELEASES_DIR
            ls -1tr | head -n -5 | xargs -d '\n' rm -rf --

            echo "âœ… Deployment completed!"
